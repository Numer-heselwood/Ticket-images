<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ticket Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Welcome, {{ username|capitalize }} ðŸ‘‹</h3>
        <a href="/logout" class="btn btn-danger btn-sm">Logout</a>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#uploadTab">Upload</button>
        </li>

        {% if role == 'office' %}
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#viewTab">View</button>
        </li>
        {% endif %}
    </ul>

    <div class="tab-content">

        <!-- ==================== UPLOAD TAB ==================== -->
        <div class="tab-pane fade show active" id="uploadTab">

            <div class="card p-3 shadow-sm">
                <h5>Upload Images / Videos</h5>

                <form id="uploadForm">
                    <input type="text" id="ticketNumber" class="form-control mb-2" placeholder="Enter Ticket Number" required>

                    <input type="file" id="mediaInput" class="form-control mb-2" accept="image/*,video/*" multiple required>

                    <button class="btn btn-primary w-100" type="submit">Upload</button>
                </form>

                <div id="uploadMessage" class="mt-2"></div>

                <!-- Preview Thumbnails -->
                <div class="row mt-3" id="previewGallery"></div>
            </div>
        </div>

        <!-- ==================== VIEW TAB (OFFICE ONLY) ==================== -->
        {% if role == 'office' %}
        <div class="tab-pane fade" id="viewTab">

            <div class="card p-3 shadow-sm">
                <h5>View Ticket Media</h5>

                <form id="viewForm">
                    <input type="text" id="viewTicketNumber" class="form-control mb-2" placeholder="Enter Ticket Number" required>
                    <button class="btn btn-success w-100" type="submit">Search</button>
                </form>

                <div id="viewMessage" class="mt-2"></div>

                <!-- Backup Button -->
                <button id="backupBtn" class="btn btn-warning w-100 mt-2 d-none">Backup Ticket</button>

                <!-- Display Gallery -->
                <div class="row mt-3 gallery" id="mediaGallery"></div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ================ PREVIEW UPLOAD ================
document.getElementById("mediaInput").addEventListener("change", function() {
    const gallery = document.getElementById("previewGallery");
    gallery.innerHTML = "";

    [...this.files].forEach(file => {
        const col = document.createElement("div");
        col.className = "col-md-4";

        if (file.type.startsWith("image")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.classList.add("img-fluid");
            col.appendChild(img);
        } else if (file.type.startsWith("video")) {
            const vid = document.createElement("video");
            vid.src = URL.createObjectURL(file);
            vid.controls = true;
            vid.classList.add("img-fluid");
            col.appendChild(vid);
        }

        gallery.appendChild(col);
    });
});

// ================ UPLOAD ======================
document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const ticket = document.getElementById("ticketNumber").value.trim();
    const files = document.getElementById("mediaInput").files;

    if (!ticket || files.length === 0) return;

    const formData = new FormData();
    formData.append("ticket_number", ticket);
    [...files].forEach(f => formData.append("images", f));

    const res = await fetch("/upload", { method: "POST", body: formData });
    const data = await res.json();

    document.getElementById("uploadMessage").innerHTML =
        data.uploaded ? `<span class='text-success'>Uploaded: ${data.uploaded.length} files</span>` :
                        `<span class='text-danger'>Upload failed</span>`;
});

// ================ VIEW ======================
document.getElementById("viewForm")?.addEventListener("submit", async function(e) {
    e.preventDefault();

    const ticket = document.getElementById("viewTicketNumber").value.trim();
    const res = await fetch("/get_media", { method: "POST", body: new URLSearchParams({ ticket_number: ticket }) });
    const data = await res.json();

    const gallery = document.getElementById("mediaGallery");
    const message = document.getElementById("viewMessage");
    const backupBtn = document.getElementById("backupBtn");

    gallery.innerHTML = "";
    backupBtn.classList.add("d-none");

    if (!data.images?.length && !data.videos?.length) {
        message.innerHTML = `<span class='text-danger'>No media found.</span>`;
        return;
    }

    message.innerHTML = `<span class='text-success'>Media loaded.</span>`;
    backupBtn.classList.remove("d-none");

    data.images.forEach(url => {
        gallery.innerHTML += `
            <div class="col-md-4 mb-3">
                <img src="${url}" class="img-fluid rounded">
            </div>
        `;
    });

    data.videos.forEach(url => {
        gallery.innerHTML += `
            <div class="col-md-4 mb-3">
                <video src="${url}" class="img-fluid rounded" controls></video>
            </div>
        `;
    });

    backupBtn.onclick = async () => {
        const r = await fetch("/backup", { method: "POST", body: new URLSearchParams({ ticket_number: ticket }) });
        const d = await r.json();
        alert(d.success ? "Backup complete!" : "Backup failed.");
    };
});
</script>

</body>
</html>
