<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéüÔ∏è Ticket System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>

  <body class="d-flex flex-column align-items-center justify-content-center">
    <div class="container text-center mt-4">
      <h2 class="mb-4">üéüÔ∏è Ticket Image System</h2>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">üì§ Upload</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">üñºÔ∏è Dashboard</button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <!-- UPLOAD TAB -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel">
          <input type="text" id="uploadTicket" class="form-control mb-3" placeholder="Enter Ticket Number" />
          <input type="file" id="uploadFiles" class="form-control mb-3" multiple />
          <button class="btn btn-primary w-100" onclick="uploadImages()">‚¨ÜÔ∏è Upload</button>
          <div id="uploadResult" class="mt-3"></div>
        </div>

        <!-- DASHBOARD TAB -->
        <div class="tab-pane fade" id="dashboard" role="tabpanel">
          <input type="text" id="ticketInput" class="form-control mb-3" placeholder="Enter Ticket Number" />
          <button class="btn btn-success w-100" onclick="loadImages()">üîç Search</button>
          <div id="gallery" class="gallery row g-3 mt-3"></div>
        </div>
      </div>
    </div>

    <!-- Dark Mode Toggle -->
    <button id="darkToggle" class="btn btn-sm btn-secondary" onclick="toggleTheme()">üåô</button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // === AUTO REFRESH EVERY 30 SECONDS ===
      setInterval(() => {
        const ticket = document.getElementById("ticketInput").value.trim();
        if (ticket) loadImages();
      }, 30000);

      // === DARK MODE TOGGLE ===
      function toggleTheme() {
        const html = document.documentElement;
        const current = html.getAttribute("data-bs-theme");
        html.setAttribute("data-bs-theme", current === "dark" ? "light" : "dark");
      }

      // === UPLOAD IMAGES ===
      async function uploadImages() {
        const ticket = document.getElementById("uploadTicket").value.trim();
        const files = document.getElementById("uploadFiles").files;
        const result = document.getElementById("uploadResult");
        result.innerHTML = "";

        if (!ticket || files.length === 0) {
          result.innerHTML = "<div class='text-danger'>Please provide ticket number and select images.</div>";
          return;
        }

        const formData = new FormData();
        formData.append("ticket_number", ticket);
        for (let file of files) formData.append("images", file);

        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();

        if (data.error) result.innerHTML = `<div class='text-danger'>${data.error}</div>`;
        else result.innerHTML = `<div class='text-success'>Uploaded: ${data.uploaded.join(", ")}</div>`;
      }

      // === LOAD IMAGES FROM FLASK ===
      async function loadImages() {
        const ticket = document.getElementById("ticketInput").value.trim();
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        if (!ticket) {
          gallery.innerHTML = "<div class='text-muted'>Please enter a ticket number.</div>";
          return;
        }

        const formData = new FormData();
        formData.append("ticket_number", ticket);

        const response = await fetch("/get_images", { method: "POST", body: formData });
        const data = await response.json();

        if (data.error) {
          gallery.innerHTML = `<div class='text-danger'>${data.error}</div>`;
          return;
        }

        if (!data.images || data.images.length === 0) {
          gallery.innerHTML = "<div class='text-warning'>No images found.</div>";
          return;
        }

        data.images.forEach((url) => {
          const col = document.createElement("div");
          col.classList.add("col-12", "col-md-4");
          col.innerHTML = `<img src="${url}" class="img-fluid rounded shadow-sm" alt="Ticket Image" />`;
          gallery.appendChild(col);
        });
      }
    </script>
  </body>
</html>
