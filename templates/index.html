<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéüÔ∏è Ticket Media System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="d-flex flex-column align-items-center justify-content-center">
  <div class="container text-center mt-4">
    <h2 class="mb-4">üéüÔ∏è Ticket Media System</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">üì§ Upload</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">üñºÔ∏è View</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Upload Tab -->
      <div class="tab-pane fade show active" id="upload" role="tabpanel">
        <input type="text" id="uploadTicket" class="form-control mb-3" placeholder="Enter Ticket Number">
        <input type="file" id="uploadFiles" class="form-control mb-3" multiple accept="image/*,video/*">

        <div id="previewGallery" class="row g-2 mb-2"></div>

        <button class="btn btn-primary w-100" onclick="confirmAndUpload()">‚¨ÜÔ∏è Upload</button>
        <div id="uploadResult" class="mt-3"></div>
      </div>

      <!-- View Tab -->
      <div class="tab-pane fade" id="dashboard" role="tabpanel">
        <input type="text" id="ticketInput" class="form-control mb-3" placeholder="Enter Ticket Number">
        <button class="btn btn-success w-100" onclick="loadMedia()">üîç Search</button>
        <div id="gallery" class="gallery row g-3 mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Dark Mode -->
  <button id="darkToggle" class="btn btn-sm btn-secondary" onclick="toggleTheme()">üåô</button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // === DARK MODE TOGGLE ===
    function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute("data-bs-theme");
      html.setAttribute("data-bs-theme", current === "dark" ? "light" : "dark");
    }

    // === PREVIEW FILES ===
    const uploadFilesInput = document.getElementById("uploadFiles");
    const previewGallery = document.getElementById("previewGallery");
    uploadFilesInput.addEventListener("change", () => {
      previewGallery.innerHTML = "";
      Array.from(uploadFilesInput.files).forEach((file, index) => {
        const col = document.createElement("div");
        col.classList.add("col-4", "col-md-3", "text-center");

        const reader = new FileReader();
        reader.onload = (e) => {
          let preview = "";
          if (file.type.startsWith("image/")) {
            preview = `<img src="${e.target.result}" class="img-fluid rounded mb-1" alt="${file.name}">`;
          } else if (file.type.startsWith("video/")) {
            preview = `<video class="img-fluid rounded mb-1" muted><source src="${e.target.result}" type="${file.type}"></video>`;
          }

          col.innerHTML = `
            ${preview}
            <div class="progress">
              <div class="progress-bar" id="progress-${index}" role="progressbar" style="width: 0%"></div>
            </div>
            <small>${file.name}</small>
          `;
        };
        reader.readAsDataURL(file);
        previewGallery.appendChild(col);
      });
    });

    // === CONFIRM + UPLOAD ===
    function confirmAndUpload() {
      if (confirm("Existing files for this ticket will be deleted. Continue?")) uploadMedia();
    }

    // === UPLOAD MEDIA ===
    async function uploadMedia() {
      const ticket = document.getElementById("uploadTicket").value.trim();
      const files = uploadFilesInput.files;
      const result = document.getElementById("uploadResult");
      result.innerHTML = "";

      if (!ticket || files.length === 0) {
        result.innerHTML = "<div class='text-danger'>Please provide ticket number and select files.</div>";
        return;
      }

      const uploadedFiles = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const formData = new FormData();
        formData.append("ticket_number", ticket);
        formData.append("media", file);

        await new Promise((resolve) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/upload");

          xhr.upload.addEventListener("progress", (e) => {
            if (e.lengthComputable) {
              const percent = (e.loaded / e.total) * 100;
              document.getElementById(`progress-${i}`).style.width = `${percent}%`;
            }
          });

          xhr.onload = () => {
            if (xhr.status === 200) uploadedFiles.push(file.name);
            resolve();
          };
          xhr.send(formData);
        });
      }

      result.innerHTML = `<div class='text-success'>Uploaded: ${uploadedFiles.join(", ")}</div>`;
    }

    // === LOAD MEDIA (Images + Videos) ===
    async function loadMedia() {
      const ticket = document.getElementById("ticketInput").value.trim();
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      if (!ticket) {
        gallery.innerHTML = "<div class='text-muted'>Please enter a ticket number.</div>";
        return;
      }

      const formData = new FormData();
      formData.append("ticket_number", ticket);

      const response = await fetch("/get_media", { method: "POST", body: formData });
      const data = await response.json();

      if (data.error) {
        gallery.innerHTML = `<div class='text-danger'>${data.error}</div>`;
        return;
      }

      if (!data.media || data.media.length === 0) {
        gallery.innerHTML = "<div class='text-warning'>No media found.</div>";
        return;
      }

      data.media.forEach((item) => {
        const col = document.createElement("div");
        col.classList.add("col-12", "col-md-4");

        if (item.type === "image") {
          col.innerHTML = `<img src="${item.url}" class="img-fluid rounded shadow-sm" alt="${item.name}">`;
        } else if (item.type === "video") {
          col.innerHTML = `
            <video controls class="img-fluid rounded shadow-sm">
              <source src="${item.url}" type="video/mp4">
              Your browser does not support video playback.
            </video>
            <small>${item.name}</small>
          `;
        }

        gallery.appendChild(col);
      });
    }
  </script>
</body>
</html>
