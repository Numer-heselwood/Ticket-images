<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéüÔ∏è Ticket System Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>

  <body class="d-flex flex-column align-items-center justify-content-center">
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>üéüÔ∏è Ticket Dashboard</h2>
        <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab">üì§ Upload</button>
        </li>

        {% if role == "office" %}
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">üñºÔ∏è View Files</button>
        </li>
        {% endif %}
      </ul>

      <div class="tab-content mt-3">
        <!-- UPLOAD TAB -->
        <div class="tab-pane fade show active" id="upload" role="tabpanel">
          <input type="text" id="uploadTicket" class="form-control mb-3" placeholder="Enter Ticket Number" />
          <input type="file" id="uploadFiles" class="form-control mb-3" multiple accept="image/*,video/*" />
          <button class="btn btn-primary w-100" onclick="uploadFiles()">‚¨ÜÔ∏è Upload Files</button>
          <div id="uploadResult" class="mt-3"></div>
        </div>

        <!-- DASHBOARD TAB -->
        {% if role == "office" %}
        <div class="tab-pane fade" id="dashboard" role="tabpanel">
          <input type="text" id="ticketInput" class="form-control mb-3" placeholder="Enter Ticket Number" />
          <button class="btn btn-success w-100" onclick="loadMedia()">üîç Search</button>
          <div id="gallery" class="row g-3 mt-3"></div>
        </div>
        {% endif %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      async function uploadFiles() {
        const ticket = document.getElementById("uploadTicket").value.trim();
        const files = document.getElementById("uploadFiles").files;
        const result = document.getElementById("uploadResult");

        if (!ticket || files.length === 0) {
          result.innerHTML = "<div class='text-danger'>Please enter ticket number and select files.</div>";
          return;
        }

        if (!confirm("This will replace existing files for this ticket. Continue?")) return;

        const formData = new FormData();
        formData.append("ticket_number", ticket);
        for (let f of files) formData.append("images", f);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload");
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            result.innerHTML = `<div class='progress'><div class='progress-bar' style='width:${percent}%;'>${percent}%</div></div>`;
          }
        };
        xhr.onload = () => {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            result.innerHTML = `<div class='text-success'>Uploaded: ${data.uploaded.join(", ")}</div>`;
          } else {
            result.innerHTML = `<div class='text-danger'>Upload failed.</div>`;
          }
        };
        xhr.send(formData);
      }

      async function loadMedia() {
        const ticket = document.getElementById("ticketInput").value.trim();
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = "";

        if (!ticket) {
          gallery.innerHTML = "<div class='text-muted'>Enter a ticket number.</div>";
          return;
        }

        const formData = new FormData();
        formData.append("ticket_number", ticket);

        const res = await fetch("/get_media", { method: "POST", body: formData });
        const data = await res.json();

        if (data.error) {
          gallery.innerHTML = `<div class='text-danger'>${data.error}</div>`;
          return;
        }

        if (data.media.length === 0) {
          gallery.innerHTML = "<div class='text-warning'>No media found.</div>";
          return;
        }

        data.media.forEach((item) => {
          const col = document.createElement("div");
          col.classList.add("col-12", "col-md-4");

          if (item.type === "video") {
            col.innerHTML = `<video controls class="w-100 rounded shadow-sm"><source src="${item.url}" type="video/mp4"></video><p>${item.name}</p>`;
          } else {
            col.innerHTML = `<img src="${item.url}" class="img-fluid rounded shadow-sm" alt="${item.name}"><p>${item.name}</p>`;
          }

          gallery.appendChild(col);
        });
      }
    </script>
  </body>
</html>
